* org-repeat-by-cron.el

[[https://melpa.org/#/org-repeat-by-cron][https://melpastats-2761cf.gitlab.io/badges/org-repeat-by-cron-badge.svg]]

基于 Cron 表达式的 Org 模式任务重复工具

修改自 [[https://github.com/Raemi/org-reschedule-by-rule]]。

不同之处：
1. 使用elisp实现的一个cron解析器，不依赖python的 =croniter= 包
2. 取消 =INTERVAL= 属性，改为 =DAY_AND= 属性
3. 支持同时或单独更新 =SCHEDULE= 与 =DEADLINE= 时间戳。
4. 兼容 =org-habit= ，让org自行处理重复的同时，自动重新计算并设置时间，最大化兼容 org-habit 等。

=org-repeat-by-cron.el= 是一个为 Emacs Org 模式设计的轻量级扩展，它允许您根据强大的 Cron 表达式来重复任务。

标准的 Org 模式重复器（如 =+1d=, =++1w= ）是基于当前的 =SCHEDULED= 或者 =DEADLINE= 时间戳的。而本工具提供了一种基于绝对时间规则的重复方式。您可以轻松设定一个任务「在每个月的最后一个星期五」或「每季度第一个周一」重复，而无需手动计算日期。

此工具的一个核心优势是纯 Elisp 实现，不依赖任何外部程序（如 Python 的 =croniter= 库），保证了在任何 Emacs 环境下的开箱即用。

** 功能特性

- 使用标准的 5 字段 Cron 表达式（ =分、时、日、月、星期= ）来定义复杂的重复规则。
- 纯 Elisp 实现，无任何外部依赖，安装简单，运行高效。
- 支持 Cron 扩展语法：
  * =L= ：表示月份或星期的「最后一天」。
  * =W= ：表示离指定日期最近的「工作日」。
  * =LW= ：表示当月最后一个「工作日」。
  * =#= ：表示「第 N 个星期 X」，例如 =5#2= 代表第二个星期五。
- 支持通过 =DAY_AND= 属性切换“日”和“星期”字段的逻辑关系（默认 =OR= ）。
- 支持月份（ =JAN-DEC= ）和星期（ =SUN-SAT= ）的英文缩写，使表达式更具可读性。
- 您可以选择让它更新任务的 =SCHEDULED= 时间戳或 =DEADLINE= 时间戳，也可以两者均独立更新（默认 =SCHEDULED= ）。

** 安装与配置

通过Melpa安装。

推荐的配置如下：
#+begin_src elisp
(use-package org-repeat-by-cron
  :config
  (global-org-repeat-by-cron-mode))
#+end_src

** 使用方法

要使一个 Org 任务能够按 Cron 规则重复，您只需在其 =PROPERTIES= 抽屉中添加 =REPEAT_CRON= 属性。

提示：这里的 =REPEAT_CRON= 属性不需要用引号包裹起来。

*** 使用范例

假如我们有一个每周末的课程：

#+begin_src org
,* TODO 周末课程
:PROPERTIES:
:REPEAT_CRON: * * SAT,SUN 
:END:
#+end_src

当其被标记为完成后，会自动计划到符合条件的日期。以今日（2025年12月9日）为例，会计划到本周六（2025年12月13日）：

#+begin_src org
,* TODO 周末课程
SCHEDULED: <2025-12-13 周六>
:PROPERTIES:
:REPEAT_CRON: * * SAT,SUN 
:REPEAT_ANCHOR: 2025-12-13 周六
:END:
#+end_src

这时候再将其标记为完成，则会根据 =REPEAT_ANCHOR= 和当前时间计划下一个符合条件的时间点，并计划到那时：

#+begin_src org
,* TODO 周末课程
SCHEDULED: <2025-12-14 周日>
:PROPERTIES:
:REPEAT_CRON: * * SAT,SUN 
:REPEAT_ANCHOR: 2025-12-14 周日
:END:
#+end_src

注意：如果不想指定重复时间的小时与分钟，应采用3段式缩写。详细讨论见后。

*** 核心属性

- =REPEAT_CRON= : *（必需）*  包含 Cron 表达式的字符串。
  
  - *5 字段格式*: =分 时 日 月 星期=  (例如 =0 9 * * *= 表示每天早上9点)。会将时间戳变为包含 =HH:MM= 的格式。
    
  - *3 字段格式*: =日 月 星期= (默认设置到天，无 =HH:MM= 属性)。
    
    - 说明：在Emacs中， =SCHEDULED= 或 =DEADLINE= 时间戳可以不标明小时与分钟。为考虑这种情况，我们采用三字段来快捷指定任务到天。如果您希望任务在 Agenda 中显示在全天列表（不带具体时刻），请务必使用 3 字段（ =日 月 周= ）。如果您需要精确到几点几分开始，请使用 5 字段。
    
- =REPEAT_DAY_AND= : *（可选）* 默认关闭，设置为 =t= 以开启。用于切换“日”与“星期”的逻辑关系。
  - 默认情况下 (OR): 表达式 =13 * FRI= 会在每月 13 号以及每个周五触发。
  - 开启后 (AND): 表达式 =13 * FRI= 仅在恰好是 13 号的周五触发（例如“黑色星期五”）。
- =REPEAT_DEADLINE= : *（可选）*
  - 设置为 =t= 时，更新 =DEADLINE= 而非 =SCHEDULED= 。 *注意：* 为了防止冲突，启用此项后会自动清除任务原有的 =SCHEDULED= 时间戳。
  - 设置为 =Cron= 表达式（如 0 18 * * 5）时，开启独立重复模式。 =SCHEDULED= 将按 =REPEAT_CRON= 重复，而 =DEADLINE= 将按此处的表达式和独立的 =REPEAT_DEADLINE_ANCHOR= 单独重复。
- =REPEAT_ANCHOR= 与 =REPEAT_DEADLINE_ANCHOR= : 由插件自动创建并维护，存储上次触发的时间基准。用户通常不需要手动干预。若现有的该项被删除，则在下次重复时会采用当前时间为基准，并重新计算设置该值。
*** 工作流程

- 在一个 Org 标题下创建一个 =PROPERTIES= 抽屉。
  
- 添加 =REPEAT_CRON= 属性并设置好您的 Cron 表达式。
  
- （可选）根据需要添加 =REPEAT_DAY_AND= 或 =REPEAT_DEADLINE= 
  
- 正常地将该任务的 =TODO= 状态变更为 =DONE=
  
- *自动发生* :
  
  - =org-repeat-by-cron= 会捕获到状态变更，并为该任务临时补全可能缺失的 =repeater= 相关文本
  - =org-mode= 自行处理重复事件，设置下一个有效时间点。
  - =org-repeat-by-cron= 根据 =REPEAT_CRON= 规则计算出下一个有效的时间点    
  - 根据计算出来的时间点，对应更新任务的 =SCHEDULED= 或 =DEADLINE= 时间戳，又或许两者皆更新，并删除掉临时补全的 =repeater= 。
    
提示：由于重复事项由org-mode自行处理， =org-repeat-by-cron= 仅会在org处理重复完成后重新设置时间戳，所以本package可以与 =org-habit= 同时启用。

** Cron 语法详解

标准 Cron 表达式由 5 个字段组成，用空格分隔。

| 字段               |                              允许的值 | 允许的特殊字符 |
|--------------------+---------------------------------------+----------------|
| 分钟 (Minute)      |                                  0-59 | * , - /        |
| 小时 (Hour)        |                                  0-23 | * , - /        |
| 日 (Day of Month)  |                                  1-31 | * , - / L W    |
| 月 (Month)         |                      1-12 或 JAN\-DEC | * , - /        |
| 星期 (Day of Week) | 0-7 (0 和 7 都代表星期日) 或 SUN\-SAT | * , - / L #    |

提示： 本解析器将 =*= 处理为全范围且支持 =DAY_AND= 切换，故略去了对特殊字符 =?= 的支持。请有规避 DOM/DOW 冲突的用户查看 =DAY_AND= 属性。
*** 特殊字符

| 字符 | 描述               | 示例                                   |
| *    | 匹配字段中的任意值 | * 在「小时」字段中表示「每小时」           |
| ,    | 列出多个值         | 1,15 在「日」字段中表示「每月1号和15号」   |
| -    | 定义一个范围       | MON-FRI 在「星期」字段中表示「周一到周五」  |
| /    | 定义步长（step）   | */15 在「分钟」字段中表示「每15分钟」      |

*** 扩展语法 (亮点功能)

- =L=
  - *「最后」* 。在「日」字段中， =L= 表示当月最后一天。在「星期」字段中， =5L= 表示当月最后一个星期五。
  - =L= (日) -> 1月31日,
  - =6L=  (星期) -> 最后一个星期六 
- =W=
  - *「最近的工作日」*  (周一至周五)。 =15W= 表示离15号最近的工作日。如果15号是周六，则匹配14号（周五）；如果15号是周日，则匹配16号（周一）。
  - 不会跨月，如果1号是周六，则 =1W= 会匹配3号（周一） ；如果31日是周日，则 =31W= 会反向匹配到29日（周五）
- =LW=   
  - *「当月最后一个工作日」* 。
- =#=
  - *「第 N 个星期 X」* 。 =DOW#N= 格式。
  - =5#2= -> 第二个星期五  =1#1,1#3= -> 第一个或第三个星期一       

** 示例

*** 示例 1: 每周报告

一个任务需要在每个周五下午 5 点重复。

#+begin_src org
,* TODO 提交每周工作报告
SCHEDULED: <2025-09-12 Fri 17:00>
:PROPERTIES:
:REPEAT_CRON: 0 17 * * FRI
:END:
#+end_src
  
*** 示例 2: 每月账单支付 (最后一天)

在每个月的最后一天提醒支付账单(使用 3 字段格式)。

#+begin_src org
,* TODO 支付信用卡账单
SCHEDULED: <2025-09-30 Tue>
:PROPERTIES:
:REPEAT_CRON: L * * 
:END:
#+end_src
  
*** 示例 3: 团队双周会

会议只在每个月的第一个和第三个星期一举行。

#+begin_src org
,* TODO 参加双周技术同步会
DEADLINE: <2025-10-06 Mon 10:00>
:PROPERTIES:
:REPEAT_CRON: 0 10 * * MON#1,MON#3
:REPEAT_DEADLINE: t
:END:
#+end_src
  
*** 示例 4: 季度维护任务

在每季度的第一个月的第一个星期一执行。

#+begin_src org
,* TODO 服务器季度维护
SCHEDULED: <2025-10-06 Mon>
:PROPERTIES:
:REPEAT_CRON: * JAN,APR,JUL,OCT MON#1
:END:
#+end_src

*** 示例 5: 黑色星期五特惠（ DAY_AND）
仅在每月 13 号且当天是周五时触发。
#+begin_src org
,* TODO 黑色星期五特惠
SCHEDULED: <2026-03-13 五>
:PROPERTIES:
:REPEAT_CRON: 13 * 5
:REPEAT_DAY_AND: t
:END:
#+end_src

*** 示例 6: 每周固定时间健身（配合 org-habit）
假设你想在 每周一、三、五 健身，并且希望在 Agenda 中看到习惯追踪条，要求最晚不能拖延超过 2 天。

#+begin_src org
,* TODO 力量训练（健身房）
SCHEDULED: <2025-09-15 Mon .+1d/2d>
:PROPERTIES:
:STYLE:    habit
:REPEAT_CRON: * * MON,WED,FRI
:END:
#+end_src

提示：在与 =org-habit= 配合的时候，请务必保留类似 =.+1d/2d= 的 Repeater，以便展示 =org-habit= 的彩色graph。

*** 示例 7: 独立双重时间戳 （REPEAT_DEADLINE）
假设你有一个每周任务，它应在每周五到期，但你会安排在周四有空时完成。
#+begin_src org
,* TODO 周度重点项目
SCHEDULED: <2025-09-08 Mon> DEADLINE: <2025-09-12 Fri>
:PROPERTIES:
:REPEAT_CRON: * * 4
:REPEAT_DEADLINE: * * FRI
:END:
#+end_src

* 更新日志

** 1.1.4 2026-02-27 更新内部逻辑
现在会通过添加临时repeater的方式让org-mode来处理todo-keywords、org-log-done等情况，以规避可能的兼容性问题。
本package仅会在org自行处理完后重新设定对应时间。

** 1.1.3 2026-02-26 修复触发条件
为了保持兼容性，上个版本移除了先前使用的 =when-let*= ，导致再次错误触发 =org-repeat-by-cron-on-done= 函数。

** 1.1.2 2026-02-26 新增scheduled/deadline并行功能
- 新增：支持独立的 =DEADLINE= 重复规则。现在 =REPEAT_DEADLINE= 属性可以填入一个独立的 =Cron= 表达式，实现与 =SCHEDULE= 的共存调度。
- 新增：引入 =REPEAT_DEADLINE_ANCHOR= 用于支持独立截止日期的计算基准。
- 优化：内部代码重构。

** 1.1.1 2026-02-25 修复触发条件
修复了错误触发 =org-repeat-by-cron-on-done= 函数的问题，现在能正确地只在有 =REAPTE_CRON= 属性的heading上触发。
** 1.1.0 2026-02-24 添加了对于repeater的处理
1. 现在可以在设置 =REPEAT_CRON= 的同时启用repeater了， =org-repeat-by-cron= 会暂存 =repeater= ，处理重复，设置对应时间并恢复暂存的 =repeater= 。
2. 一些代码逻辑的优化。

** 1.0.5 2026-02-02 修复了1个问题
若下列条件按顺序有任一满足，则会将时间戳显示为包含小时分钟的格式（"%Y-%m-%d %a %H:%M"）：
1. cron格式为5字段，暗示了需要小时分钟；
2. anchor-str中包含了小时与分钟（"HH:MM"）
3. scheduled或deadline的时间戳中包含了小时与分钟（"HH:MM"）

** 1.0.4 2026-01-18 修复了1个问题
调整了字符L和数字的顺序，由 =L5= 变为 =5L= ，以保持与[[https://en.wikipedia.org/wiki/Cron#Non-standard_characters][cron规则]]的一致性
** 1.0.3 2025-12-25 更新Commentary

** 1.0.2 2025-10-28 修复了2个问题
1. 现在比较时会正确采用 =base-time= 和 =current-time= 中较大一方
2. 把默认的触发hook由 =org-after-todo-state-change-hook= 改为 =org-trigger-hook= ，以便更好处理相关函数

** 1.0.1 2025-09-22 更新README
** 1.0.0 2025-09-21 初始化
